<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GameFit — Game Compatibility Checker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <nav class="nav">
      <div class="nav-inner">
        <div class="logo">
          <div class="logo-icon"></div>
          <div class="logo-text">GameFit</div>
        </div>
        <div class="nav-actions">
          <button id="start-btn" class="btn btn-primary"><i class="fas fa-play"></i>&nbsp; Start System Scan</button>
        </div>
      </div>
    </nav>
    
    <main class="container">
      <section class="hero">
        <h1>Game Compatibility Checker</h1>
        <p class="lead">Instantly check if your PC can run any game</p>
      </section>

      <div id="loader" class="loader hidden"></div>

      <div id="logBox" class="log-box hidden">
        <div id="logMessages"></div>
      </div>

      <section id="specs" class="section hidden">
        <h2>Your System Specifications</h2>
        <div id="spec-grid" class="spec-grid"></div>
      </section>

      <section id="games" class="section hidden">
        <h2>Compatible Games</h2>
        <div class="search-filter">
          <input type="text" id="search-input" placeholder="Search games by name... (includes non‑compatible)">
          <select id="ram-filter">
            <option value="">All RAM</option>
            <option value="4">Min RAM: 4GB+</option>
            <option value="8">Min RAM: 8GB+</option>
            <option value="16">Min RAM: 16GB+</option>
          </select>
          <select id="vram-filter">
            <option value="">All VRAM</option>
            <option value="2">Min VRAM: 2GB+</option>
            <option value="4">Min VRAM: 4GB+</option>
            <option value="8">Min VRAM: 8GB+</option>
          </select>
        </div>
        <div id="games-grid" class="games-grid"></div>
      </section>

    </main>

    <div id="see-all-btn-container" class="see-all-container hidden">
      <button id="see-all-btn" class="btn btn-secondary">Show All Games</button>
    </div>

    <!-- Game Details Modal -->
    <div id="gameModal" class="modal hidden">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modal-content">
          <img id="modal-image" src="" alt="Game Image" />
          <h2 id="modal-title"></h2>
          <div id="modal-compatibility-badge" class="compatibility-badge"></div>
          <div class="requirements">
            <h3>System Requirements</h3>
            <div class="req-section">
              <h4>Minimum</h4>
              <p id="modal-os-min"></p>
              <p id="modal-cpu-min"></p>
              <p id="modal-ram-min"></p>
              <p id="modal-gpu-min"></p>
              <p id="modal-vram-min"></p>
              <p id="modal-storage-min"></p>
            </div>
            <div class="req-section">
              <h4>Recommended</h4>
              <p id="modal-os-rec"></p>
              <p id="modal-cpu-rec"></p>
              <p id="modal-ram-rec"></p>
              <p id="modal-gpu-rec"></p>
              <p id="modal-vram-rec"></p>
              <p id="modal-storage-rec"></p>
            </div>
          </div>
          <div class="availability">
            <h3>Available On</h3>
            <div id="modal-platforms"></div>
            <h3>Download From</h3>
            <div id="modal-stores"></div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">Made with  — GameFit</footer>

    <script>
      const startBtn = document.getElementById('start-btn');
      const loader = document.getElementById('loader');
      const specsSection = document.getElementById('specs');
      const gamesSection = document.getElementById('games');
      const specGrid = document.getElementById('spec-grid');
      const gamesGrid = document.getElementById('games-grid');
      const logBox = document.getElementById('logBox');
      const logMessages = document.getElementById('logMessages');
      const gameModal = document.getElementById('gameModal');
      const closeBtn = document.getElementsByClassName('close')[0];

      let gameData = []; // Store game data globally

      function addLogMessage(message) {
        const timestamp = new Date().toLocaleTimeString();
        logMessages.innerHTML += `[${timestamp}] ${message}<br>`;
        logMessages.scrollTop = logMessages.scrollHeight;
      }

      // Modal close functionality
      closeBtn.onclick = function() {
        gameModal.classList.remove('show');
      }
      window.onclick = function(event) {
        if (event.target == gameModal) {
          gameModal.classList.remove('show');
        }
      }

      async function showGameDetails(game) {
        // If game details aren't loaded yet, fetch them
        if (!game.image && game.platforms.length === 0 && game.stores.length === 0) {
          addLogMessage(`Loading details for ${game.name}...`);
          try {
            const encodedName = encodeURIComponent(game.name);
            const res = await fetch(`/api/game/${encodedName}`);
            const details = await res.json();
            // Update the game object with fetched details
            game.image = details.image;
            game.platforms = details.platforms;
            game.stores = details.stores;
            // compatibility fields may come from this call
            if (details.compatibility_percent !== undefined) {
              game.compatibility_percent = details.compatibility_percent;
            }
            if (details.compatibility_color) {
              game.compatibility_color = details.compatibility_color;
            }
            addLogMessage(`Details loaded for ${game.name}`);
          } catch (e) {
            addLogMessage(`Failed to load details for ${game.name}`);
            console.error('Error loading game details:', e);
          }
        }

        document.getElementById('modal-image').src = game.image || '/static/placeholder.svg';
        document.getElementById('modal-title').textContent = game.name;
        // compatibility badge inside modal
        const badge = document.getElementById('modal-compatibility-badge');
        if (badge) {
          badge.textContent = `${game.compatibility_percent || ''}% compatible`;
          badge.style.backgroundColor = game.compatibility_color || badge.style.backgroundColor;
        }
        document.getElementById('modal-os-min').textContent = `OS: ${game.os_min}`;
        document.getElementById('modal-cpu-min').textContent = `CPU: ${game.cpu_min}`;
        document.getElementById('modal-ram-min').textContent = `RAM: ${game.ram_min}`;
        document.getElementById('modal-gpu-min').textContent = `GPU: ${game.gpu_min}`;
        document.getElementById('modal-vram-min').textContent = `VRAM: ${game.vram_min || 'N/A'}`;
        document.getElementById('modal-storage-min').textContent = `Storage: ${game.storage_min}`;
        document.getElementById('modal-os-rec').textContent = `OS: ${game.os_rec || 'N/A'}`;
        document.getElementById('modal-cpu-rec').textContent = `CPU: ${game.cpu_rec}`;
        document.getElementById('modal-ram-rec').textContent = `RAM: ${game.ram_rec}`;
        document.getElementById('modal-gpu-rec').textContent = `GPU: ${game.gpu_rec}`;
        document.getElementById('modal-vram-rec').textContent = `VRAM: ${game.vram_rec || 'N/A'}`;
        document.getElementById('modal-storage-rec').textContent = `Storage: ${game.storage_rec}`;
        
        // Create platform links
        const platformsDiv = document.getElementById('modal-platforms');
        if (game.platforms.length > 0) {
          const platformLinks = game.platforms.map(platform => {
            const url = getPlatformUrl(platform);
            return url ? `<a href="${url}" target="_blank" class="platform-link">${platform}</a>` : platform;
          });
          platformsDiv.innerHTML = platformLinks.join(', ');
        } else {
          platformsDiv.innerHTML = 'Not available';
        }
        
        // Create store links
        const storesDiv = document.getElementById('modal-stores');
        if (game.stores.length > 0) {
          const storeLinks = game.stores.map(store => {
            const url = getStoreUrl(store, game.name);
            return url ? `<a href="${url}" target="_blank" class="store-link">${store}</a>` : store;
          });
          storesDiv.innerHTML = storeLinks.join(', ');
        } else {
          storesDiv.innerHTML = 'Not available';
        }
        
        gameModal.classList.add('show');
      }

      function displayGames(games) {
        gamesGrid.innerHTML = '';
        games.forEach(g => {
          const card = document.createElement('div');
          card.className = 'game-card';
          // border color based on compatibility
          if (g.compatibility_color) {
            card.style.border = `2px solid ${g.compatibility_color}`;
          }
          card.innerHTML = `\
            <div class="compatibility-badge" style="background-color: ${g.compatibility_color || 'hsl(0,80%,45%)'}">${g.compatibility_percent || 0}%</div>\
            <img src="${g.image || '/static/placeholder.svg'}" alt="${g.name}" />\
            <h3>${g.name}</h3>\
            <p>Min RAM: ${g.ram_min}  Min VRAM: ${g.gpu_min || g.vram_min || 'N/A'}</p>`;
          card.style.cursor = 'pointer';
          card.addEventListener('click', () => showGameDetails(g));
          gamesGrid.appendChild(card);
        });
      }

      // Search and Filter functionality
      const searchInput = document.getElementById('search-input');
      const ramFilter = document.getElementById('ram-filter');
      const vramFilter = document.getElementById('vram-filter');

      async function filterGames() {
        const searchTerm = searchInput.value.trim();
        const ramMin = parseFloat(ramFilter.value) || 0;
        const vramMin = parseFloat(vramFilter.value) || 0;
        const heading = document.querySelector('#games h2');

        if (searchTerm.length > 0) {
          heading.textContent = 'Search Results';
          // ask the server for matching entries (may include incompatible titles)
          try {
            const res = await fetch(`/api/games?search=${encodeURIComponent(searchTerm)}`);
            const data = await res.json();
            let filtered = data.games || [];
            // apply additional RAM/VRAM filters on the results
            filtered = filtered.filter(g => {
              const okRam = parseFloat(g.ram_min || 0) >= ramMin;
              const okVram = parseFloat(g.vram_min || 0) >= vramMin;
              return okRam && okVram;
            });
            displayGames(filtered);
            document.getElementById('see-all-btn-container').classList.add('hidden');
            return;
          } catch (e) {
            console.error('Search request failed', e);
          }
        } else {
          heading.textContent = 'Compatible Games';
        }

        // no search term, just show compatible games
        if (!showingAllGames) {
          displayGames(compatibleGames.slice(0, 4));
        } else {
          displayGames(compatibleGames);
        }
        document.getElementById('see-all-btn-container').classList.remove('hidden');
      }

      searchInput.addEventListener('input', filterGames);
      ramFilter.addEventListener('change', filterGames);
      vramFilter.addEventListener('change', filterGames);

      function getPlatformUrl(platform) {
        const platformUrls = {
          'PC': 'https://store.steampowered.com/',
          'PlayStation 4': 'https://store.playstation.com/',
          'PlayStation 5': 'https://store.playstation.com/',
          'Xbox One': 'https://www.microsoft.com/store/games/xbox',
          'Xbox Series S/X': 'https://www.microsoft.com/store/games/xbox',
          'Nintendo Switch': 'https://www.nintendo.com/store/',
          'macOS': 'https://store.steampowered.com/',
          'Linux': 'https://store.steampowered.com/',
          'Android': 'https://play.google.com/store/games',
          'iOS': 'https://apps.apple.com/us/app/itunes-store/id461504587'
        };
        return platformUrls[platform] || null;
      }

      function getStoreUrl(store, gameName) {
        const encodedGameName = encodeURIComponent(gameName);
        const storeUrls = {
          'Steam': `https://store.steampowered.com/search/?term=${encodedGameName}`,
          'Epic Games': `https://store.epicgames.com/browse?q=${encodedGameName}`,
          'GOG': `https://www.gog.com/games?query=${encodedGameName}`,
          'Microsoft Store': `https://www.microsoft.com/store/search/games?q=${encodedGameName}`,
          'PlayStation Store': `https://store.playstation.com/search/${encodedGameName}`,
          'Nintendo eShop': `https://www.nintendo.com/search/#category=all&query=${encodedGameName}`,
          'Google Play': `https://play.google.com/store/search?q=${encodedGameName}`,
          'App Store': `https://apps.apple.com/us/search?term=${encodedGameName}`,
          'Itch.io': `https://itch.io/search?q=${encodedGameName}`,
          'Humble Store': `https://www.humblebundle.com/store/search?search=${encodedGameName}`
        };
        return storeUrls[store] || null;
      }

      startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        loader.classList.remove('hidden');
        logBox.classList.remove('hidden');
        specsSection.classList.add('hidden');
        gamesSection.classList.add('hidden');
        // Ensure button is hidden at start of scan
        document.getElementById('see-all-btn-container').classList.add('hidden');
        // Reset button state
        showingAllGames = false;
        logMessages.innerHTML = '';
        
        try {
          addLogMessage('Initializing system scan...');
          addLogMessage('Fetching system specifications...');
          const res = await fetch('/api/games');
          addLogMessage('Processing system data...');
          const data = await res.json();
          addLogMessage('System specifications retrieved successfully.');
          
          specGrid.innerHTML = '';
          for (const [k, v] of Object.entries(data.system_info)) {
            const el = document.createElement('div');
            el.className = 'spec-card';
            el.innerHTML = `<strong>${k}</strong><div>${v}</div>`;
            specGrid.appendChild(el);
          }
          specsSection.classList.remove('hidden');
          addLogMessage('Checking game compatibility...');

          gamesGrid.innerHTML = '';
          compatibleGames = data.games; // store full set for later
          console.log('Compatible games found:', compatibleGames.length);
          if (compatibleGames.length === 0) {
            gamesGrid.innerHTML = '<p>No compatible games found.</p>';
            addLogMessage('No compatible games found.');
          } else {
            addLogMessage(`Found ${compatibleGames.length} compatible games.`);
            // pick a preview that shows range rather than just top entries
            if (compatibleGames.length > 4) {
              // keep two highest and two lowest percentages if there is variation
              const sorted = compatibleGames.slice().sort((a,b)=>a.compatibility_percent-b.compatibility_percent);
              const lowest = sorted.slice(0,2);
              const highest = sorted.slice(-2);
              gameData = highest.concat(lowest);
            } else {
              gameData = compatibleGames.slice();
            }
            displayGames(gameData);
          }
          gamesSection.classList.remove('hidden');
          addLogMessage('Scan completed successfully.');
          
          // Show the "Show All Games" button after a brief delay to ensure everything is rendered
          if (compatibleGames.length > 4) {
            console.log('Will show see all button after delay, games found:', compatibleGames.length);
            setTimeout(() => {
              console.log('Showing see all button now');
              const btnContainer = document.getElementById('see-all-btn-container');
              btnContainer.classList.remove('hidden');
              btnContainer.style.display = 'block';
              addLogMessage('Click "Show All Games" to see all compatible games.');
            }, 1000); // 1 second delay after scan completion
          } else {
            console.log('No need for button, 4 or fewer games found');
          }
        } catch (err) {
          addLogMessage('Error during scan: ' + err.message);
          alert('Error fetching system info. Check console for details.');
          console.error(err);
        } finally {
          loader.classList.add('hidden');
          logBox.classList.add('hidden');
          startBtn.disabled = false;
        }
      });

      // See All Compatible Games button functionality
      const seeAllBtn = document.getElementById('see-all-btn');
      let showingAllGames = false;
      let compatibleGames = []; // store full results from initial scan

      console.log('See all button element:', seeAllBtn);

      seeAllBtn.addEventListener('click', () => {
        console.log('See all button clicked, current state:', showingAllGames);
        
        if (!showingAllGames) {
          // Show all games
          displayGames(compatibleGames);
          // Change button text
          seeAllBtn.textContent = 'Show Less Games';
          showingAllGames = true;
          addLogMessage(`All ${compatibleGames.length} compatible games displayed.`);
        } else {
          // Show only first 4 games
          displayGames(compatibleGames.slice(0, 4));
          // Change button text back
          seeAllBtn.textContent = 'Show All Games';
          showingAllGames = false;
          addLogMessage('Showing top 4 compatible games.');
        }
      });
    </script>
  </body>
</html>
